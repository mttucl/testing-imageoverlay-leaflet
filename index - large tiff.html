
<html>
    <head>
    
        <title>Leaflet - Small GeoTIFF</title>
    
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
      <script src="https://www.unpkg.com/geotiff@2.0.7/dist-browser/geotiff.js"></script>
      <script src="https://unpkg.com/chroma-js@2.4.2/chroma.js"></script>
    
        <style>
            #map {
                width: 1000px;
                height: 800px;
            }
        </style>
    
    
    </head>
    <body>
    
    <div id='map'></div>
    
    <script>

          // setup map
   var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
              });

     var map = L.map('map', {
       layers: [baseLayer] // , bandsWindLayer
     }).setView([10, 80], 5);



    
    var xhr = new XMLHttpRequest();
xhr.open('GET', 'alt-seasia-large.tiff', true);
xhr.responseType = 'arraybuffer';
xhr.onload = async function(e) {

  // process geotiff file data
    var tiff = await GeoTIFF.fromArrayBuffer(this.response);
    var image = await tiff.getImage();
    var tiffWidth = image.getWidth();
    var tiffHeight = image.getHeight();
    const pool = new GeoTIFF.Pool();
    var rasters = await image.readRasters({ pool: pool });
    var tiepoint = image.getTiePoints()[0];
    const extent = image.getBoundingBox();
    var pixelScale = image.getFileDirectory().ModelPixelScale;

  
  

// get temp data from raster for popup click
    var tempData = new Array(tiffHeight);
    for (var j = 0; j<tiffHeight; j++){
        tempData[j] = new Array(tiffWidth);
        for (var i = 0; i<tiffWidth; i++){
           tempData[j][i] = rasters[0][i + j*tiffWidth];
        }
    }

            // rgba of raster data function
            function color_array_to_canvas(array, width, height) {

                let colorScale = chroma.scale(["#3b528b", "#abdc32"]);

                var rgba = new Uint8ClampedArray(4*width*height);
                for (var i = 0; i < width*height; i++) {
                    rgba[4*i] = colorScale(array[i])._rgb[0];
                    rgba[4*i+1] = colorScale(array[i])._rgb[1];
                    rgba[4*i+2] = colorScale(array[i])._rgb[2];
                    rgba[4*i+3] = 255;
                }      
                var imgData = new ImageData(rgba, width, height);
                return imgData;
            }    
  
   // color image data
  let imagData = color_array_to_canvas(rasters[0], tiffWidth, tiffHeight);
  
  // create canvas
  let canvas = document.createElement('canvas');
  canvas.width = tiffWidth;
  canvas.height = tiffHeight;
  canvas.style.display = "none";

  let ctx = canvas.getContext("2d");
  ctx.putImageData(imagData, 0, 0);
  

  



  // raster bounds
  let imageBounds = [[extent[3], extent[2]], [extent[1], extent[0]]];



    let imageLayer = L.imageOverlay(canvas.toDataURL(), imageBounds,{
       opacity: 0.8
     });


    // markers at raster bounds
    let marker = L.marker(imageBounds[0]).addTo(map);
     let marker2 = L.marker(imageBounds[1]).addTo(map);

    let marker3 = L.marker([9.51,79.68]).addTo(map);

  // add to map
     L.control.layers(null, {
      "Image": imageLayer
      }).addTo(map);
      imageLayer.addTo(map)


            let southWest_lat = imageBounds[1][0];
            let southWest_lng = imageBounds[1][1];
            let northEast_lat = imageBounds[0][0];
            let northEast_lng = imageBounds[0][1];            
  

    // get values with click
    map.on('click', function(e) {
              let xTiff = Math.floor(tiffWidth * (e.latlng.lng - southWest_lng) / (northEast_lng -southWest_lng));
              let yTiff = tiffHeight - Math.ceil(tiffHeight * (e.latlng.lat - southWest_lat) / (northEast_lat - southWest_lat));
            let temp;
            if (tempData[Math.round(yTiff)] && tempData[Math.round(yTiff)][Math.round(xTiff)]){
              temp = tempData[Math.round(yTiff)][Math.round(xTiff)];
            }

          if (temp){
            L.popup()
              .setLatLng(e.latlng)
              .setContent("Elev: " + temp.toFixed(1) + " m")
              .openOn(map);
          }    
    });

  };
  xhr.send();

    </script>
    
    </body>
    </html>